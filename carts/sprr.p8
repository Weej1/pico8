pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

function normalize(u,v,scale)
	scale=scale or 1
	local d=sqrt(u*u+v*v)
	if (d>0) u/=d v/=d
	return u*scale,v*scale
end

function fast_sprr(sx,sy,x,y,a)
 local x0,y0=4,4
	
	local ducol,dvcol=sin(-a),cos(-a)
	local durow=ducol
	local dvrow=-dvcol
	
	local su=sx+4-(4*dvcol+4*ducol)
	local sv=sy+4-(4*dvrow+4*durow)

	local rowu=su
	local rowv=sv
	
	local u,v
	for j=y,y+7 do
		u,v=rowu,rowv
		for i=x,x+7 do
			local c=sget(sx+band(u,7),sy+band(v,7))
			pset(i,j,c)
			u+=durow
			v+=dvrow
		end
		rowu+=ducol
		rowv+=dvcol
	end
end

function rspr(sx,sy,x,y,a,w)
	local ca,sa=cos(a),sin(a)
 local ddx0,ddy0=ca,sa
 local mask=shl(0xfff8,(w-1))
 w=shl(w,2)
 local dx0,dy0=(sa-ca)*(w-0.5)+w,(ca+sa)*(0.5-w)+w
 w=shl(w,1)-1
 for ix=x,x+w do
  local srcx,srcy=dx0,dy0
  for iy=y,w+y do
   if band(bor(srcx,srcy),mask)==0 then
   	sset(ix,iy,sget(sx+srcx,sy+srcy))
  	end
   srcx-=ddy0
  	srcy+=ddx0
  end
  dx0+=ddx0
  dy0+=ddy0
 end
end

local time_t=0
local plyr={
	x=0,y=0,
	dx=0,dy=0,
	acc=0,
	angle=0,
	da=0,
	sx=48,
	sy=0
}

local parts={}
function make_part(x,y)
	add(parts,{
		x=x,y=y,
		t=time_t+rnd(30)
	})
end

function update_parts()
	for _,p in pairs(parts) do
		if p.t<time_t then
			del(parts,p)
		end
	end	
end

function draw_parts()
	for i=1,#parts do
		local p0=parts[i]
		pset(64+p0.x,64+p0.y,7)
	end
end

function _update60()
	time_t+=1

	if(btn(2)) plyr.da=0.01
	if(btn(3)) plyr.da=-0.01
	
	plyr.angle+=plyr.da
	plyr.da*=0.96
	
	-- simulate air friction
	plyr.dx*=0.95
	plyr.dy*=0.95
	-- apply thrust force
	local dx,dy=cos(plyr.angle),sin(plyr.angle)
	plyr.dx+=dx
	plyr.dy+=dy
	local u,v=normalize(plyr.dx,plyr.dy)
	dx,dy=normalize(dx,dy)
	plyr.x+=u*plyr.acc
	plyr.y+=v*plyr.acc

	-- calculate drift force
	if abs(dx*u+dy*v)<0.90 then
		make_part(plyr.x+rnd(2)-1-8*u,plyr.y+rnd(2)-1-8*v)
	end
	
	update_parts()
end

function _draw()
	cls(0)
	
	draw_parts()
	
	palt(0,false)
	palt(14,true)

 for i=1,16 do
		rspr(plyr.sx,plyr.sy,32,16,-plyr.angle,2)	
	end
	
	local x,y=64+plyr.x-8,64+plyr.y-8
 --[[
	pal(6,0)
	spr(36,x+1,y,2,2)
	spr(36,x-1,y,2,2)
	spr(36,x,y+1,2,2)
	spr(36,x,y-1,2,2)
	
	pal(6,6)
	]]
	spr(36,x,y,2,2)

	rectfill(0,0,127,8,1)
	print(stat(1),2,2,7)
end

__gfx__
00000000eeeeeeeeee0000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00000000ee88eeeee0999a0eee0000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeddddeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00700700e000000e091414a0ee0650eeeeee00eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeddddddddeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00077000e088777009444490ee0650eeeeee060eeeeeeeeeeeeeeeeeeeeeeeeeeeeddddddddddeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00077000e055667004555440ee0990eeeeee0660eeeeeeeeeeeeeeeeeeeeeeeeeedddddddddddeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00700700e000000e0339bbb0ee0440eeeee0066000000eeeeee666eeeee66eeeeddddddddddddeddddddddeeeeeeeeee00000000000000000000000000000000
00000000ee88eeee003000b0eee00eeeee066666666cc0eeeee666e666eeeeeeeddddddddddddddddddddddeeeeeeeee00000000000000000000000000000000
00000000eeeeeeeeee0eee0eeeeeeeeeee070000007cc70eeeee666666666eeeeddddddddddddddddddddddeeddddeee00000000000000000000000000000000
00000000eeeeeeee0000000000000000ee0655555666650eeee66666666666eeedddddddddddddddddddddddddddddee00000000000000000000000000000000
00000000eeeeeeee0000000000000000eee00000555550eeeeee666666666eeeeeddddddddddddddddddddddddddddee00000000000000000000000000000000
00000000ee00000e0000000000000000eeeeeeee00000eeeeee666e666eeeeeeeedddddddddddddddddddddddddddddd00000000000000000000000000000000
00000000e049550e0000000000000000eeeeeeeeeeeeeeeeeee666eeeee66eeeeeeddddddddddddddddddddddddddddd00000000000000000000000000000000
00000000e049660e0000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeddddddddddedddddddddddddddd00000000000000000000000000000000
00000000ee00000e0000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00000000eeeeeeee0000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00000000eeeeeeee0000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
